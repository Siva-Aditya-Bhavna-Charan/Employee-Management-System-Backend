<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<link rel="icon" type="image/png" href="/images/logo.png" sizes="32x32">
<link rel="stylesheet" href="/css/adminDashboard.css">
</head>
<body>
	
	<div id="loader" class="loader">
        <div class="ring"></div>
        <div class="ring"></div>
        <div class="ring"></div>
        <span>Loading..</span>
    </div>
	
	<div class="dashboard-container" id="dashboard">
		<header>
			<h1>Admin Dashboard</h1>
			<input type="text" class="Search" onchange="filterEmployees()"
				placeholder="Search for employees..."><br>
			<div class="header-buttons">
				<button class="add-employee-btn">
					<a href="/admin/create">Add Employee</a>
				</button>
				<!-- <button class="admin-name-btn">Admin Name</button> -->
				<button class="logout-btn">
					<a href="/logout">Log Out</a>
				</button>
			</div>
		</header>


		<!-- Cards Section -->
		<section class="dashboard-cards">
			<div class="card">
				<img src="/images/emp.png" alt="Employee Icon" class="card-icon">
				<h3>536</h3>
				<p>Total No. of Employees</p>
				<span>Full-time: 495 | New Hires: 41</span> <span>Growth: +5%
					this month</span>
			</div>
			<div class="card">
				<img src="/images/pro.png" alt="Projects Icon" class="card-icon">
				<h3>85</h3>
				<p>Total projects done by company</p>
				<span>Completed: 60 | Ongoing: 20</span> <span>Completion
					Rate: 85%</span>
			</div>
			<div class="card">
				<img src="/images/fin.png" alt="Finance Icon" class="card-icon">
				<h3>$5.2M</h3>
				<p>Total revenue generated</p>
				<span>Product Sales: $3.5M | Services: $1.2M</span> <span>Growth:
					+12% this quarter</span>
			</div>
			<div class="card">
				<div>
					<p class="project-title">Project Details</p>
					<br> <span class="project-name">Employee Management <br>
						System (EMS)
					</span><br>
					<br> <span class="team-size">Team size – 8 People</span>
				</div>
				<div class="circle-progress">
					<svg>
                            <circle cx="40" cy="40" r="35"></circle>
                            <circle cx="40" cy="40" r="35"
							style="stroke-dashoffset: 22;"></circle>
                        </svg>
					<div class="percentage">80%</div>
				</div>
			</div>
		</section>


		<section class="employee-details">
			<h2>Employee Details</h2>
			<br>
			<table>
				<thead>
					<tr>
						<th>Emp ID</th>
						<th>Name</th>
						<th>Company Mail</th>
						<th>HR Name</th>
						<th>Current Project</th>
						<th>Action Buttons</th>
					</tr>
				</thead>
				<tbody id="employee-table-body">
					<!-- Employee data will be dynamically inserted here -->
				</tbody>
			</table>
			<div id="pagination-controls">
				<button id="prev-btn" onclick="prevPage()" disabled>Previous</button>
				<span id="page-info"></span>
				<button id="next-btn" onclick="nextPage()" disabled>Next</button>
			</div>
		</section>
	</div>

	<script>
            let data=[];
            let currentPage = 1;  
            const recordsPerPage = 10;
		
            function delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
			async function fetchAllEmployees(){
				try {
	                const [response] = await Promise.all([
	                    fetch('http://localhost:8080/api/list').then(res => res.json()),
	                    delay(1000)
	                ]);

	                data = response;
	                displayData(data);
	                document.getElementById('loader').style.display = 'none'; 
	  	            document.getElementById('dashboard').style.display = 'block';
	            } catch (error) {
	                console.error('Error fetching employee data:', error);
	                document.getElementById('loader').style.display = 'none';
	            }
			}
            
			window.onload=fetchAllEmployees;
			
			function filterEmployees() {
        		const searchQuery = document.querySelector('.Search').value.toLowerCase();

        		// Filter the employeeData array based on the search query (e.g., by name or employment code)
		        const filteredData = data.filter(employee => {
		            return (
		                employee.personalDetails.fullName.toLowerCase().includes(searchQuery) || 
		                employee.employmentCode.includes(searchQuery)
		            );
		        });
        
		        currentPage = 1;
		        displayEmployees(getPageData(filteredData, currentPage));
		        updatePaginationControls(filteredData);
		        
		        // Display the filtered results
		        displayData(filteredData);
    		}
			
			
		    function displayData(data) {
		    const tableBody = document.getElementById('employee-table-body');
		    tableBody.innerHTML = ''; // Clear the table before inserting new data

		    if (data.length === 0) {
		        
		    	// If no data, display a message in the table body
		        const noDataRow = document.createElement('tr');
		        noDataRow.innerHTML = `<td colspan="6" style="text-align: center;">No data is available</td>`;
		        tableBody.appendChild(noDataRow);
		        
		        return; // Exit the function early since there's no data to display
		    }

    		data.forEach(employee => {
        	// Create a new row
        		const row = document.createElement('tr');

        	// Insert employee data into the row
		        row.innerHTML = `
		            <td>${employee.employmentCode}</td>
		            <td>${employee.personalDetails.fullName}</td>
		            <td>${employee.companyMail}</td>
		            <td>${employee.professionalDetails.hrName}</td>
		            <td>${employee.projects.length > 0 ? employee.projects[0].projectName : 'No Project Assigned'}</td>
		            <td>
		                <button class="view-btn"><a class="view-link" data-id="${employee.id}" onclick="navigate_to_view()">View</a></button>
		                <button class="update-btn"><a class="update-link" data-id="${employee.id}" onclick="navigate_to_update()">Update</a></button>
		                <button class="delete-btn" data-id="${employee.id}">Delete</button>
		            </td>
		        `;

		        // Append the row to the table body
		        tableBody.appendChild(row);
   			});

    		// Add delete button event listeners
		    const deleteButtons = document.querySelectorAll('.delete-btn');
		    deleteButtons.forEach(button => {
		        button.addEventListener('click', (event) => {
		            const employeeId = event.target.getAttribute('data-id');
		            deleteEmployee(employeeId);
		        });
		    });
		}
 

		function getPageData(data, page) {
	        const startIndex = (page - 1) * recordsPerPage;
	        const endIndex = startIndex + recordsPerPage;
	        return data.slice(startIndex, endIndex);
	    }

	    function updatePaginationControls(data = data) {
	        const totalPages = Math.ceil(data.length / recordsPerPage);
	        const pageInfo = document.getElementById('page-info');
	        const prevBtn = document.getElementById('prev-btn');
	        const nextBtn = document.getElementById('next-btn');
	
	        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
	        prevBtn.disabled = currentPage === 1;
	        nextBtn.disabled = currentPage === totalPages;
	    }

	    function nextPage() {
	        currentPage++;
	        displayEmployees(getPageData(data, currentPage));
	        updatePaginationControls();
	    }

	    function prevPage() {
	        currentPage--;
	        displayEmployees(getPageData(data, currentPage));
	        updatePaginationControls();
	    }
	    
		function navigate_to_view(event){

    		const viewButtons = document.querySelectorAll('.view-btn>a');

			viewButtons.forEach(button => {
			  button.addEventListener('click', function() {
			    const id = this.getAttribute('data-id');
			   
			    
			    if(id){
			    	window.location.href = `/admin/view?id=${encodeURIComponent(id)}`;
				}
				else{
				  	alert("id is not valid.")
				}
    		});
  		});

	}
	function navigate_to_update(){
   
    	const updateButtons = document.querySelectorAll('.update-btn>a');

		updateButtons.forEach(button => {
		  button.addEventListener('click', function() {
		    const id = this.getAttribute('data-id');
		   
		    
		    if(id){
		    window.location.href = `/admin/update?id=${encodeURIComponent(id)}`;
		}
		else{
		  alert("id is not valid.")
		}
		    });
		  });
		}
		// Function to delete an employee
		function deleteEmployee(id) {
		fetch(`http://localhost:8080/api/${id}`, {
		    method: 'DELETE'
		})
		.then(response => {
		    if (response.ok) {
		        alert('Employee deleted successfully');
		        // Optionally, refresh the employee list
		        location.reload(); // Refresh the page to update the employee list
		    } else {
		        alert('Error deleting employee');
		    }
		})
		.catch(error => console.error('Error deleting employee:', error));
		}
        </script>
	</div>
</body>
</html>